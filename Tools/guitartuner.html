<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æç®€æ™ºèƒ½å‰ä»–è°ƒéŸ³å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            color: white;
            padding: 10px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 500px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin: 10px;
        }
        
        h1 {
            margin-bottom: 15px;
            font-size: clamp(1.5rem, 5vw, 2rem);
        }
        
        .tuner-display {
            margin: 20px 0;
            position: relative;
        }
        
        .current-note {
            font-size: clamp(1.5rem, 6vw, 2.5rem);
            font-weight: bold;
            margin-bottom: 8px;
            height: 40px;
            min-height: 40px;
        }
        
        .detected-note {
            font-size: clamp(1.2rem, 5vw, 2rem);
            font-weight: bold;
            margin-bottom: 8px;
            color: #fbc531; /* é»„è‰²æ˜¾ç¤ºå®é™…æ£€æµ‹åˆ°çš„éŸ³ç¬¦ */
            height: 35px;
            min-height: 35px;
        }
        
        .frequency {
            font-size: clamp(0.9rem, 3vw, 1.2rem);
            margin-bottom: 8px;
            opacity: 0.8;
        }
        
        .deviation {
            font-size: clamp(0.9rem, 3vw, 1.1rem);
            margin-bottom: 12px;
            font-weight: bold;
        }
        
        .deviation.low {
            color: #ff6b81; /* çº¢è‰² - éŸ³ä½ */
        }
        
        .deviation.high {
            color: #3742fa; /* è“è‰² - éŸ³é«˜ */
        }
        
        .deviation.correct {
            color: #2ed573; /* ç»¿è‰² - å‡†ç¡® */
        }
        
        .stability-meter {
            width: 100%;
            height: 16px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin: 12px 0;
            overflow: hidden;
        }
        
        .stability-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff6b81, #fbc531, #2ed573);
            border-radius: 8px;
            transition: width 0.3s ease;
        }
        
        .stability-text {
            font-size: clamp(0.7rem, 2.5vw, 0.9rem);
            margin-top: 4px;
            opacity: 0.8;
        }
        
        .tuner-gauge {
            width: 100%;
            max-width: 300px;
            height: 24px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            margin: 15px auto;
            position: relative;
            overflow: hidden;
        }
        
        .gauge-fill {
            height: 100%;
            width: 50%;
            background: linear-gradient(90deg, #ff6b81 0%, #fbc531 50%, #2ed573 100%);
            border-radius: 12px;
            position: relative;
            transition: width 0.3s ease;
        }
        
        .gauge-center {
            position: absolute;
            top: 0;
            left: 50%;
            width: 2px;
            height: 100%;
            background: white;
            z-index: 2;
        }
        
        .gauge-pointer {
            position: absolute;
            top: 0;
            width: 6px;
            height: 100%;
            background: white;
            border-radius: 3px;
            transform: translateX(-50%);
            z-index: 3;
            transition: all 0.1s ease-out;
        }
        
        .note-indicators {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            padding: 0 10px;
            font-size: clamp(0.7rem, 2vw, 0.8rem);
        }
        
        .note-indicator {
            opacity: 0.7;
        }
        
        .controls {
            margin: 15px 0;
        }
        
        button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: clamp(0.9rem, 3vw, 1rem);
            margin: 0 5px;
            transition: all 0.3s ease;
            min-width: 80px;
            min-height: 40px;
        }
        
        button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            margin-top: 12px;
            font-size: clamp(0.8rem, 2.5vw, 0.9rem);
            opacity: 0.8;
        }
        
        .guitar-strings {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .string {
            width: clamp(35px, 8vw, 45px);
            height: clamp(35px, 8vw, 45px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: clamp(0.9rem, 3vw, 1.1rem);
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            flex-shrink: 0;
        }
        
        .string:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .string.selected {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border-color: #fff;
            color: #333;
            box-shadow: 0 0 15px rgba(255, 154, 158, 0.7);
            transform: scale(1.1);
        }
        
        .string.active {
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }
        
        .accuracy {
            margin-top: 12px;
            font-size: clamp(0.9rem, 3vw, 1.1rem);
            font-weight: bold;
        }
        
        .accuracy.perfect {
            color: #2ed573;
        }
        
        .accuracy.close {
            color: #fbc531;
        }
        
        .accuracy.far {
            color: #ff6b81;
        }
        
        .selected-string-info {
            margin-top: 12px;
            font-size: clamp(0.8rem, 2.5vw, 0.9rem);
            opacity: 0.9;
        }
        
        .direction-hint {
            margin-top: 8px;
            font-size: clamp(0.8rem, 2.5vw, 0.9rem);
        }
        
        .direction-hint.low {
            color: #ff6b81;
        }
        
        .direction-hint.high {
            color: #3742fa;
        }
        
        .confidence-meter {
            margin-top: 8px;
            font-size: clamp(0.7rem, 2vw, 0.8rem);
        }
        
        .gauge-labels {
            margin-top: 10px;
        }
        
        .gauge-labels div {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            font-size: clamp(0.7rem, 2vw, 0.8rem);
        }
        
        .chord-display {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            font-size: clamp(0.9rem, 3vw, 1rem);
        }
        
        .chord-name {
            font-weight: bold;
            color: #fbc531;
            margin-bottom: 5px;
        }
        
        .chord-notes {
            display: flex;
            justify-content: center;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .chord-note {
            background: rgba(255, 255, 255, 0.1);
            padding: 3px 6px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 5px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .tuner-gauge {
                height: 20px;
            }
            
            .gauge-pointer {
                height: 100%;
            }
            
            .string {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            button {
                padding: 8px 12px;
                font-size: 0.9rem;
                min-width: 70px;
                min-height: 36px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }
            
            h1 {
                font-size: 1.3rem;
            }
            
            .current-note {
                font-size: 1.8rem;
            }
            
            .detected-note {
                font-size: 1.5rem;
            }
            
            .tuner-gauge {
                height: 18px;
            }
            
            .gauge-pointer {
                height: 100%;
            }
            
            .string {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            
            .guitar-strings {
                gap: 4px;
            }
            
            button {
                padding: 6px 10px;
                font-size: 0.8rem;
                min-width: 60px;
                min-height: 32px;
            }
        }
        
        /* å¹³æ¿é€‚é… */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                padding: 25px;
            }
            
            .string {
                width: 42px;
                height: 42px;
                font-size: 1.05rem;
            }
            
            .tuner-gauge {
                height: 22px;
            }
        }
        
        /* æ¡Œé¢ç«¯é€‚é… */
        @media (min-width: 1025px) {
            .container {
                padding: 30px;
            }
            
            .string {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }
            
            .tuner-gauge {
                height: 24px;
            }
        }
        
        /* æ¨ªå±é€‚é… */
        @media (orientation: landscape) and (max-height: 500px) {
            .container {
                padding: 10px;
                margin: 5px;
            }
            
            .tuner-display {
                margin: 10px 0;
            }
            
            .string {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
        }
        
        /* é˜²æ­¢ç¼©æ”¾ */
        input, textarea, select {
            font-size: 16px !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¸ æç®€å‰ä»–è°ƒéŸ³å™¨</h1>
        
        <div class="tuner-display">
            <div class="current-note" id="currentNote">-</div>
            <div class="detected-note" id="detectedNote">-</div>
            <div class="frequency" id="frequency">é¢‘ç‡: - Hz</div>
            <div class="deviation" id="deviation">åå·®: -</div>
            
            <div class="stability-meter">
                <div class="stability-fill" id="stabilityFill"></div>
            </div>
            <div class="stability-text" id="stabilityText">ç­‰å¾…ç¨³å®šéŸ³é«˜...</div>
            
            <div class="tuner-gauge">
                <div class="gauge-center"></div>
                <div class="gauge-pointer" id="gaugePointer" style="left: 50%;"></div>
                <div class="gauge-fill" id="gaugeFill" style="width: 50%;"></div>
            </div>
            
            <div class="note-indicators">
                <span class="note-indicator">åä½</span>
                <span class="note-indicator">å‡†ç¡®</span>
                <span class="note-indicator">åé«˜</span>
            </div>
            
            <div class="accuracy" id="accuracy">å‡†å¤‡å°±ç»ª</div>
            <div class="direction-hint" id="directionHint">è¯·å¼€å§‹è°ƒéŸ³</div>
            <div class="confidence-meter" id="confidenceMeter">ç¨³å®šæ€§: 0%</div>
        </div>
        
        <div class="controls">
            <button id="startBtn">å¼€å§‹è°ƒéŸ³</button>
            <button id="stopBtn" disabled>åœæ­¢</button>
        </div>
        
        <div class="status" id="status">ç‚¹å‡»å¼€å§‹æŒ‰é’®å¯ç”¨éº¦å…‹é£</div>
        
        <div class="selected-string-info" id="selectedStringInfo">è¯·é€‰æ‹©è¦è°ƒéŸ³çš„ç´å¼¦</div>
        
        <div class="chord-display">
            <div class="chord-name">å½“å‰å’Œå¼¦:</div>
            <div class="chord-notes" id="chordNotes">-</div>
        </div>
        
        <div class="gauge-labels">
            <div>
                <span>éŸ³ä½</span>
                <span>å‡†ç¡®</span>
                <span>éŸ³é«˜</span>
            </div>
        </div>
        
        <div class="guitar-strings">
            <div class="string" data-note="E2" data-name="ä½éŸ³E">Eâ‚‚</div>
            <div class="string" data-note="A2" data-name="A">Aâ‚‚</div>
            <div class="string" data-note="D3" data-name="D">Dâ‚ƒ</div>
            <div class="string" data-note="G3" data-name="G">Gâ‚ƒ</div>
            <div class="string" data-note="B3" data-name="B">Bâ‚ƒ</div>
            <div class="string" data-note="E4" data-name="é«˜éŸ³E">Eâ‚„</div>
        </div>
    </div>

    <script>
        class GuitarTuner {
            constructor() {
                this.audioContext = null;
                this.analyser = null;
                this.microphone = null;
                this.scriptProcessor = null;
                
                this.targetFrequencies = {
                    'E2': 82.41,
                    'A2': 110.00,
                    'D3': 146.83,
                    'G3': 196.00,
                    'B3': 246.94,
                    'E4': 329.63
                };
                
                this.currentFrequency = 0;
                this.closestNote = '-';
                this.detectedNote = '-';
                this.isRunning = false;
                this.selectedString = null;
                
                // ç¨³å®šæ€§æ£€æµ‹ç›¸å…³å˜é‡
                this.frequencyHistory = [];
                this.stabilityThreshold = 5;
                this.frequencyVarianceThreshold = 2;
                this.stableFrequency = 0;
                this.stabilityCount = 0;
                this.isStable = false;
                
                // å’Œå¼¦æ£€æµ‹ç›¸å…³
                this.chordDetectionHistory = [];
                this.chordNotes = new Set();
                
                this.initializeElements();
                this.bindEvents();
                
                // å¯åŠ¨å®æ—¶æ£€æµ‹å®šæ—¶å™¨
                this.startRealTimeDetection();
            }
            
            initializeElements() {
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.currentNoteEl = document.getElementById('currentNote');
                this.detectedNoteEl = document.getElementById('detectedNote');
                this.frequencyEl = document.getElementById('frequency');
                this.deviationEl = document.getElementById('deviation');
                this.accuracyEl = document.getElementById('accuracy');
                this.statusEl = document.getElementById('status');
                this.stringElements = document.querySelectorAll('.string');
                this.selectedStringInfo = document.getElementById('selectedStringInfo');
                this.directionHint = document.getElementById('directionHint');
                this.gaugePointer = document.getElementById('gaugePointer');
                this.gaugeFill = document.getElementById('gaugeFill');
                this.stabilityFill = document.getElementById('stabilityFill');
                this.stabilityText = document.getElementById('stabilityText');
                this.confidenceMeter = document.getElementById('confidenceMeter');
                this.chordNotesEl = document.getElementById('chordNotes');
            }
            
            bindEvents() {
                this.startBtn.addEventListener('click', () => this.start());
                this.stopBtn.addEventListener('click', () => this.stop());
                
                // ä¸ºç´å¼¦æ·»åŠ ç‚¹å‡»äº‹ä»¶
                this.stringElements.forEach((el, index) => {
                    el.addEventListener('click', () => {
                        this.selectString(el.dataset.note, el.dataset.name, index);
                    });
                });
                
                // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æš‚åœ/æ¢å¤
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.isRunning) {
                        this.pause();
                    }
                });
            }
            
            startRealTimeDetection() {
                // å³ä½¿æ²¡æœ‰å¼€å¯éº¦å…‹é£ä¹ŸæŒç»­æ£€æµ‹éŸ³é¢‘
                if (navigator.mediaDevices && !this.isRunning) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // æ¯1000msæ›´æ–°ä¸€æ¬¡å’Œå¼¦æ˜¾ç¤º
                setInterval(() => {
                    if (this.frequencyHistory.length > 0) {
                        this.updateChordDisplay();
                    }
                }, 1000);
            }
            
            async start() {
                try {
                    this.statusEl.textContent = 'æ­£åœ¨å¯åŠ¨éº¦å…‹é£...';
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: { 
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false
                        } 
                    });
                    
                    this.setupAudioContext(stream);
                    this.startBtn.disabled = true;
                    this.stopBtn.disabled = false;
                    this.statusEl.textContent = 'éº¦å…‹é£å·²å¯ç”¨ï¼Œå¼€å§‹åˆ†æéŸ³é¢‘...';
                    this.isRunning = true;
                    
                    // é‡ç½®ç¨³å®šæ€§ç›¸å…³å˜é‡
                    this.frequencyHistory = [];
                    this.stableFrequency = 0;
                    this.stabilityCount = 0;
                    this.isStable = false;
                    this.chordNotes.clear();
                    this.updateChordDisplay();
                    this.updateStabilityDisplay(0, "ç­‰å¾…ç¨³å®šéŸ³é«˜...");
                    
                } catch (error) {
                    console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', error);
                    this.statusEl.textContent = 'æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®';
                }
            }
            
            setupAudioContext(stream) {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.analyser = this.audioContext.createAnalyser();
                this.microphone = this.audioContext.createMediaStreamSource(stream);
                this.scriptProcessor = this.audioContext.createScriptProcessor(2048, 1, 1);
                
                this.analyser.smoothingTimeConstant = 0.8;
                this.analyser.fftSize = 4096;
                
                this.microphone.connect(this.analyser);
                this.analyser.connect(this.scriptProcessor);
                this.scriptProcessor.connect(this.audioContext.destination);
                
                this.scriptProcessor.onaudioprocess = (event) => {
                    if (!this.isRunning) return;
                    this.processAudio(event.inputBuffer.getChannelData(0));
                };
            }
            
            processAudio(buffer) {
                const frequencies = this.getFrequencies(buffer);
                if (frequencies && frequencies.length > 0) {
                    const dominantFreq = this.getDominantFrequency(frequencies);
                    if (dominantFreq > 0) {
                        this.handleFrequency(dominantFreq);
                    }
                }
            }
            
            handleFrequency(frequency) {
                // å°†æ–°é¢‘ç‡æ·»åŠ åˆ°å†å²è®°å½•
                this.frequencyHistory.push({
                    freq: frequency,
                    timestamp: Date.now()
                });
                
                // é™åˆ¶å†å²è®°å½•é•¿åº¦ï¼ˆä¿ç•™æœ€è¿‘2ç§’çš„æ•°æ®ï¼‰
                const now = Date.now();
                this.frequencyHistory = this.frequencyHistory.filter(item => 
                    now - item.timestamp < 2000
                );
                
                // æ£€æŸ¥ç¨³å®šæ€§
                this.checkStability();
                
                // æ›´æ–°å’Œå¼¦æ£€æµ‹
                this.updateChordDetection(frequency);
                
                // æ›´æ–°æ˜¾ç¤º
                this.updateDisplay();
            }
            
            updateChordDetection(frequency) {
                // å°†é¢‘ç‡è½¬æ¢ä¸ºéŸ³ç¬¦
                const note = this.frequencyToNote(frequency).note;
                if (note !== '-' && note !== 'noise') {
                    // æ·»åŠ åˆ°å’Œå¼¦éŸ³ç¬¦é›†åˆ
                    this.chordNotes.add(note);
                    
                    // é™åˆ¶å’Œå¼¦éŸ³ç¬¦æ•°é‡ï¼ˆæœ€å¤šåŒæ—¶æ˜¾ç¤º6ä¸ªéŸ³ç¬¦ï¼‰
                    if (this.chordNotes.size > 6) {
                        // ç§»é™¤æœ€æ—©æ·»åŠ çš„éŸ³ç¬¦
                        const firstNote = this.chordNotes.values().next().value;
                        this.chordNotes.delete(firstNote);
                    }
                }
            }
            
            updateChordDisplay() {
                // æ¸…ç†è¿‡æœŸçš„éŸ³ç¬¦ï¼ˆè¶…è¿‡3ç§’æ²¡æœ‰æ£€æµ‹åˆ°çš„éŸ³ç¬¦ï¼‰
                const now = Date.now();
                const activeFrequencies = this.frequencyHistory.map(item => item.freq);
                
                // åªä¿ç•™æœ€è¿‘æ£€æµ‹åˆ°çš„éŸ³ç¬¦
                const currentNotes = new Set();
                activeFrequencies.forEach(freq => {
                    const note = this.frequencyToNote(freq).note;
                    if (note !== '-' && note !== 'noise') {
                        currentNotes.add(note);
                    }
                });
                
                this.chordNotes = currentNotes;
                
                // æ›´æ–°æ˜¾ç¤º
                if (this.chordNotes.size > 0) {
                    const notesArray = Array.from(this.chordNotes);
                    this.chordNotesEl.innerHTML = notesArray.map(note => 
                        `<span class="chord-note">${note}</span>`
                    ).join('');
                } else {
                    this.chordNotesEl.textContent = '-';
                }
            }
            
            checkStability() {
                if (this.frequencyHistory.length < this.stabilityThreshold) {
                    this.isStable = false;
                    this.stabilityCount = 0;
                    return;
                }
                
                // è·å–æœ€è¿‘çš„é¢‘ç‡æ•°æ®
                const recentFrequencies = this.frequencyHistory.slice(-this.stabilityThreshold).map(item => item.freq);
                const avgFreq = recentFrequencies.reduce((sum, freq) => sum + freq, 0) / recentFrequencies.length;
                
                // è®¡ç®—æ–¹å·®
                const variance = recentFrequencies.reduce((sum, freq) => sum + Math.pow(freq - avgFreq, 2), 0) / recentFrequencies.length;
                const stdDev = Math.sqrt(variance);
                
                // å¦‚æœæ ‡å‡†å·®å°äºé˜ˆå€¼ï¼Œåˆ™è®¤ä¸ºé¢‘ç‡ç¨³å®š
                if (stdDev < this.frequencyVarianceThreshold) {
                    this.stabilityCount++;
                    if (this.stabilityCount >= 3) { // è¿ç»­3æ¬¡ç¨³å®šåˆ™ç¡®è®¤
                        this.isStable = true;
                        this.stableFrequency = avgFreq;
                    }
                } else {
                    this.stabilityCount = 0;
                    this.isStable = false;
                }
                
                // æ›´æ–°ç¨³å®šæ€§æ˜¾ç¤º
                const stabilityPercent = Math.min(100, (this.stabilityCount / 3) * 100);
                let stabilityMessage = "éŸ³é«˜ä¸ç¨³å®š";
                if (this.stabilityCount >= 3) {
                    stabilityMessage = "éŸ³é«˜ç¨³å®š âœ“";
                } else if (this.stabilityCount >= 1) {
                    stabilityMessage = "éŸ³é«˜æ¥è¿‘ç¨³å®š...";
                }
                
                this.updateStabilityDisplay(stabilityPercent, stabilityMessage);
            }
            
            updateStabilityDisplay(percent, message) {
                this.stabilityFill.style.width = `${percent}%`;
                this.stabilityText.textContent = message;
                this.confidenceMeter.textContent = `ç¨³å®šæ€§: ${Math.round(percent)}%`;
            }
            
            getFrequencies(buffer) {
                // ä½¿ç”¨è‡ªç›¸å…³å‡½æ•°æ¥ä¼°è®¡åŸºé¢‘
                const size = buffer.length;
                let rms = 0;
                
                // è®¡ç®—å‡æ–¹æ ¹å€¼
                for (let i = 0; i < size; i++) {
                    rms += buffer[i] * buffer[i];
                }
                rms = Math.sqrt(rms / size);
                
                if (rms < 0.01) return null; // ä¿¡å·å¤ªå¼±
                
                // è‡ªç›¸å…³è®¡ç®—
                const autocorrelation = new Float32Array(size);
                for (let lag = 0; lag < size; lag++) {
                    let sum = 0;
                    for (let i = 0; i < size - lag; i++) {
                        sum += buffer[i] * buffer[i + lag];
                    }
                    autocorrelation[lag] = sum;
                }
                
                // æ‰¾åˆ°ç¬¬ä¸€ä¸ªå³°å€¼
                let maxPeak = 0;
                let maxIndex = 0;
                
                for (let i = 1; i < size; i++) {
                    if (autocorrelation[i] > autocorrelation[i - 1] && 
                        autocorrelation[i] > autocorrelation[i + 1]) {
                        if (autocorrelation[i] > maxPeak) {
                            maxPeak = autocorrelation[i];
                            maxIndex = i;
                        }
                    }
                }
                
                if (maxIndex > 0) {
                    const frequency = this.audioContext.sampleRate / maxIndex;
                    return [frequency];
                }
                
                return null;
            }
            
            getDominantFrequency(frequencies) {
                if (!frequencies || frequencies.length === 0) return 0;
                return frequencies[0];
            }
            
            updateDisplay() {
                // å®æ—¶æ˜¾ç¤ºå½“å‰æ£€æµ‹åˆ°çš„é¢‘ç‡ä¿¡æ¯
                if (this.frequencyHistory.length > 0) {
                    const currentFreq = this.frequencyHistory[this.frequencyHistory.length - 1].freq;
                    const noteInfo = this.frequencyToNote(currentFreq);
                    
                    // ç¬¬ä¸€è¡Œæ˜¾ç¤ºæœ€æ¥è¿‘çš„æ ‡å‡†éŸ³ç¬¦ï¼ˆE2/A2/D3/G3/B3/E4ï¼‰
                    this.closestNote = noteInfo.note;
                    this.currentNoteEl.textContent = this.closestNote;
                    
                    // ç¬¬äºŒè¡Œæ˜¾ç¤ºå®é™…æ£€æµ‹åˆ°çš„éŸ³ç¬¦ï¼ˆåŒ…æ‹¬å‡é™å·ç­‰ï¼‰
                    this.detectedNote = this.frequencyToMidiNote(currentFreq);
                    this.detectedNoteEl.textContent = this.detectedNote;
                    
                    this.frequencyEl.textContent = `é¢‘ç‡: ${currentFreq.toFixed(2)} Hz`;
                    
                    // æ›´æ–°åå·®æ˜¾ç¤º
                    this.updateDeviation(noteInfo.deviation, noteInfo.targetFreq);
                    
                    // æ›´æ–°ä»ªè¡¨ç›˜
                    this.updateGauge(noteInfo.deviation);
                    
                    // æ›´æ–°å‡†ç¡®æ€§æ˜¾ç¤º
                    this.updateAccuracy(noteInfo.deviation);
                    
                    // é«˜äº®å½“å‰æœ€æ¥è¿‘çš„ç´å¼¦
                    this.highlightClosestString(this.closestNote);
                    
                    // å¦‚æœé€‰æ‹©äº†ç´å¼¦ï¼Œæ˜¾ç¤ºæ–¹å‘æç¤º
                    if (this.selectedString) {
                        this.updateDirectionHint(noteInfo.deviation);
                    } else {
                        this.directionHint.textContent = 'è¯·å…ˆé€‰æ‹©ç´å¼¦';
                        this.directionHint.className = 'direction-hint';
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°é¢‘ç‡
                    this.currentNoteEl.textContent = '-';
                    this.detectedNoteEl.textContent = '-';
                    this.frequencyEl.textContent = 'é¢‘ç‡: - Hz';
                    this.deviationEl.textContent = 'åå·®: -';
                    this.deviationEl.className = 'deviation';
                    this.updateGauge(0);
                    this.updateAccuracy(0);
                    this.directionHint.textContent = this.selectedString ? 'ç­‰å¾…éŸ³é¢‘è¾“å…¥...' : 'è¯·å…ˆé€‰æ‹©ç´å¼¦';
                    this.directionHint.className = 'direction-hint';
                    
                    // æ¸…é™¤é«˜äº®
                    this.stringElements.forEach(el => {
                        if (!el.classList.contains('selected')) {
                            el.classList.remove('active');
                        }
                    });
                }
            }
            
            frequencyToNote(frequency) {
                if (frequency <= 0) return { note: '-', deviation: 0, targetFreq: 0 };
                
                // è®¡ç®—æœ€æ¥è¿‘çš„æ ‡å‡†éŸ³ç¬¦
                let closestNote = '';
                let minDiff = Infinity;
                let targetFreq = 0;
                
                for (const [note, freq] of Object.entries(this.targetFrequencies)) {
                    const diff = Math.abs(freq - frequency);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestNote = note;
                        targetFreq = freq;
                    }
                }
                
                const deviation = ((frequency - targetFreq) / targetFreq) * 100;
                
                return {
                    note: closestNote,
                    deviation: deviation,
                    targetFreq: targetFreq
                };
            }
            
            // æ–°å¢æ–¹æ³•ï¼šå°†é¢‘ç‡è½¬æ¢ä¸ºç²¾ç¡®çš„MIDIéŸ³ç¬¦åï¼ˆå¸¦å‡é™å·ï¼‰
            frequencyToMidiNote(frequency) {
                if (frequency <= 0) return '-';
                
                // MIDIéŸ³ç¬¦ç¼–å·è®¡ç®—å…¬å¼
                const midiNote = 69 + 12 * Math.log2(frequency / 440);
                const noteNumber = Math.round(midiNote);
                
                // éŸ³ç¬¦åç§°æ•°ç»„ï¼ˆC, C#, D, D#, E, F, F#, G, G#, A, A#, Bï¼‰
                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                
                // è®¡ç®—å…«åº¦å’ŒéŸ³ç¬¦å
                const octave = Math.floor(noteNumber / 12) - 1;
                const noteIndex = noteNumber % 12;
                const noteName = noteNames[noteIndex];
                
                // è®¡ç®—å®é™…éŸ³åˆ†åå·®ï¼ˆcentsï¼‰
                const actualFreq = 440 * Math.pow(2, (midiNote - 69) / 12);
                const cents = Math.round(1200 * Math.log2(frequency / actualFreq));
                
                // å¦‚æœåå·®å¾ˆå°ï¼Œç›´æ¥è¿”å›éŸ³ç¬¦å
                if (Math.abs(cents) <= 10) {
                    return `${noteName}${octave}`;
                } else {
                    // æ˜¾ç¤ºå¸¦æœ‰åå·®çš„éŸ³ç¬¦å
                    const deviationSymbol = cents >= 0 ? '+' : '';
                    return `${noteName}${octave} (${deviationSymbol}${cents}Â¢)`;
                }
            }
            
            updateDeviation(deviation, targetFreq) {
                if (deviation === 0) {
                    this.deviationEl.textContent = 'å®Œç¾åŒ¹é…!';
                    this.deviationEl.className = 'deviation correct';
                } else if (deviation < 0) {
                    this.deviationEl.textContent = `åä½ ${(Math.abs(deviation)).toFixed(2)}%`;
                    this.deviationEl.className = 'deviation low';
                } else {
                    this.deviationEl.textContent = `åé«˜ ${(deviation).toFixed(2)}%`;
                    this.deviationEl.className = 'deviation high';
                }
            }
            
            updateGauge(deviation) {
                // è®¡ç®—æŒ‡é’ˆä½ç½® (ä»-100%åˆ°100%ï¼Œå¯¹åº”ä»0%åˆ°100%çš„ä»ªè¡¨ç›˜ä½ç½®)
                let position = 50 + (deviation * 0.5); // åå·®èŒƒå›´-100%åˆ°+100%ï¼Œæ˜ å°„åˆ°0%-100%
                position = Math.max(0, Math.min(100, position));
                
                // æ›´æ–°æ°´å¹³ä»ªè¡¨ç›˜æŒ‡é’ˆ
                this.gaugePointer.style.left = `${position}%`;
                
                // æ›´æ–°å¡«å……å®½åº¦ä»¥æ˜¾ç¤ºå½“å‰åŒºåŸŸ
                if (deviation < -5) {
                    // éŸ³åä½åŒºåŸŸ
                    this.gaugeFill.style.width = `${position}%`;
                    this.gaugeFill.style.background = 'linear-gradient(90deg, #ff6b81 0%, #ff6b81 50%, #fbc531 100%)';
                } else if (deviation > 5) {
                    // éŸ³åé«˜åŒºåŸŸ
                    this.gaugeFill.style.width = `${position}%`;
                    this.gaugeFill.style.background = 'linear-gradient(90deg, #ff6b81 0%, #fbc531 50%, #2ed573 50%, #2ed573 100%)';
                } else {
                    // å‡†ç¡®åŒºåŸŸ
                    this.gaugeFill.style.width = `${position}%`;
                    this.gaugeFill.style.background = 'linear-gradient(90deg, #ff6b81 0%, #fbc531 50%, #2ed573 100%)';
                }
            }
            
            updateDirectionHint(deviation) {
                if (deviation < -1) {
                    this.directionHint.textContent = 'éœ€è¦æé«˜éŸ³é«˜ â†’ æ‹§ç´§ç´å¼¦';
                    this.directionHint.className = 'direction-hint low';
                } else if (deviation > 1) {
                    this.directionHint.textContent = 'éœ€è¦é™ä½éŸ³é«˜ â†’ æ”¾æ¾ç´å¼¦';
                    this.directionHint.className = 'direction-hint high';
                } else {
                    this.directionHint.textContent = 'éŸ³å‡†å®Œç¾!';
                    this.directionHint.className = 'direction-hint';
                }
            }
            
            updateAccuracy(deviation) {
                if (Math.abs(deviation) < 1) {
                    this.accuracyEl.textContent = 'âœ… éå¸¸å‡†ç¡®';
                    this.accuracyEl.className = 'accuracy perfect';
                } else if (Math.abs(deviation) < 5) {
                    this.accuracyEl.textContent = 'âš ï¸ æ¥è¿‘æ ‡å‡†';
                    this.accuracyEl.className = 'accuracy close';
                } else {
                    this.accuracyEl.textContent = 'âŒ éœ€è¦è°ƒæ•´';
                    this.accuracyEl.className = 'accuracy far';
                }
            }
            
            highlightClosestString(currentNote) {
                this.stringElements.forEach(el => {
                    if (el.dataset.note === currentNote && !el.classList.contains('selected')) {
                        el.classList.add('active');
                    } else if (el.classList.contains('active') && !el.classList.contains('selected')) {
                        el.classList.remove('active');
                    }
                });
            }
            
            selectString(note, name, index) {
                // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©çŠ¶æ€
                this.stringElements.forEach(el => {
                    el.classList.remove('selected');
                });
                
                // è®¾ç½®å½“å‰é€‰æ‹©çŠ¶æ€
                this.stringElements[index].classList.add('selected');
                
                // æ›´æ–°çŠ¶æ€ä¿¡æ¯
                this.selectedString = note;
                this.selectedStringInfo.textContent = `æ­£åœ¨è°ƒéŸ³: ${name} å¼¦ (${note}) - ç›®æ ‡é¢‘ç‡: ${this.targetFrequencies[note]} Hz`;
                
                // æ›´æ–°çŠ¶æ€æ 
                this.statusEl.textContent = `å·²é€‰æ‹©${name}å¼¦ï¼Œè¯·å¼¹å¥è¯¥å¼¦è¿›è¡Œè°ƒéŸ³`;
                
                // é‡ç½®ç¨³å®šæ€§æ£€æµ‹
                this.frequencyHistory = [];
                this.stableFrequency = 0;
                this.stabilityCount = 0;
                this.isStable = false;
                this.updateStabilityDisplay(0, "ç­‰å¾…ç¨³å®šéŸ³é«˜...");
            }
            
            pause() {
                if (this.isRunning) {
                    this.isRunning = false;
                    this.statusEl.textContent = 'é¡µé¢ä¸å¯è§ï¼Œå·²æš‚åœ';
                }
            }
            
            stop() {
                this.isRunning = false;
                
                if (this.scriptProcessor) {
                    this.scriptProcessor.disconnect();
                }
                
                if (this.microphone) {
                    this.microphone.disconnect();
                }
                
                if (this.analyser) {
                    this.analyser.disconnect();
                }
                
                // å…³é—­æ‰€æœ‰éŸ³é¢‘æµè½¨é“
                if (this.audioContext) {
                    this.audioContext.close();
                }
                
                this.startBtn.disabled = false;
                this.stopBtn.disabled = true;
                this.statusEl.textContent = 'å·²åœæ­¢';
                this.currentNoteEl.textContent = '-';
                this.detectedNoteEl.textContent = '-';
                this.frequencyEl.textContent = 'é¢‘ç‡: - Hz';
                this.deviationEl.textContent = 'åå·®: -';
                this.deviationEl.className = 'deviation';
                this.accuracyEl.textContent = 'å‡†å¤‡å°±ç»ª';
                this.accuracyEl.className = 'accuracy';
                this.directionHint.textContent = 'è¯·å…ˆé€‰æ‹©ç´å¼¦å¹¶å¼€å§‹è°ƒéŸ³';
                this.directionHint.className = 'direction-hint';
                
                // é‡ç½®ä»ªè¡¨ç›˜
                this.gaugePointer.style.left = '50%';
                this.gaugeFill.style.width = '50%';
                this.gaugeFill.style.background = 'linear-gradient(90deg, #ff6b81 0%, #fbc531 50%, #2ed573 100%)';
                
                // é‡ç½®ç¨³å®šæ€§æ˜¾ç¤º
                this.updateStabilityDisplay(0, "ç­‰å¾…ç¨³å®šéŸ³é«˜...");
                
                this.stringElements.forEach(el => {
                    el.classList.remove('active');
                    el.classList.remove('selected');
                });
                
                this.selectedStringInfo.textContent = 'è¯·é€‰æ‹©è¦è°ƒéŸ³çš„ç´å¼¦';
                
                // æ¸…ç©ºé¢‘ç‡å†å²
                this.frequencyHistory = [];
                this.chordNotes.clear();
                this.chordNotesEl.textContent = '-';
            }
        }
        
        // åˆå§‹åŒ–è°ƒéŸ³å™¨
        document.addEventListener('DOMContentLoaded', () => {
            const tuner = new GuitarTuner();
            window.tunerInstance = tuner;
        });
        
        // å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œå¦‚æœä¹‹å‰åœ¨è¿è¡Œï¼Œæ¢å¤è¿è¡Œ
                if (window.tunerInstance && window.tunerInstance.isPaused) {
                    window.tunerInstance.resume();
                }
            }
        });
    </script>
</body>
</html>
